name: Self-Hosted Price Tracker

on:
  schedule:
    - cron: '0 4 * * *' # 10h sáng mỗi ngày
  workflow_dispatch:    # Nút bấm chạy tay

jobs:
  scrape_job:
    runs-on: self-hosted # Chạy trên máy của bạn
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        # Bước này sẽ tải toàn bộ code + thư mục configs về máy bạn

      - name: Install Python & Libraries
        run: |
          # Cài thư viện (Nếu máy bạn chưa có thì nó sẽ cài)
          python -m pip install --upgrade pip
          python -m pip install selenium webdriver-manager gspread oauth2client

      - name: Create Service Account File (PowerShell Safe)
        shell: powershell
        run: |
          # Lấy nội dung từ Secret và ghi ra file service_account.json
          # Dùng cách này để tránh lỗi ký tự lạ trên Windows
          $content = '${{ secrets.GDRIVE_CREDS }}'
          if (-not $content) { Write-Error "SECRET IS EMPTY!" }
          [System.IO.File]::WriteAllText("service_account.json", $content, [System.Text.Encoding]::UTF8)
          Write-Host "✅ File service_account.json created successfully."

      - name: Run Main Script
        # Chạy file main_local.py
        run: python main_local.py
